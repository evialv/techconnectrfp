name: "RFP Agent Evaluation"

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      agent_type:
        description: 'Which agent to evaluate'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - summary
          - risk
          - compliance
      use_latest_version:
        description: 'Fetch latest agent versions from Foundry'
        required: true
        default: true
        type: boolean
  push:
    branches:
      - main
    paths:
      - 'data/**'
      - '.github/workflows/rfp-evaluation.yml'

permissions:
  id-token: write
  contents: read

env:
  # Default agent names (version fetched dynamically if use_latest_version=true)
  SUMMARY_AGENT_NAME: "RfpSummaryAgent"
  RISK_AGENT_NAME: "RfpRiskAgent"
  COMPLIANCE_AGENT_NAME: "RfpComplianceAgent"
  ORCHESTRATOR_AGENT_NAME: "RfpOrchestratorAgent"

jobs:
  # First job: Fetch latest agent versions from Foundry
  fetch-agent-versions:
    runs-on: ubuntu-latest
    name: Fetch Latest Agent Versions
    outputs:
      summary_agent_id: ${{ steps.get-versions.outputs.summary_agent_id }}
      risk_agent_id: ${{ steps.get-versions.outputs.risk_agent_id }}
      compliance_agent_id: ${{ steps.get-versions.outputs.compliance_agent_id }}
      orchestrator_agent_id: ${{ steps.get-versions.outputs.orchestrator_agent_id }}
    
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Azure SDK (preview - needed for list_versions/get_version)
        run: pip install "azure-ai-projects>=2.0.0b1" --pre azure-identity

      - name: Get Latest Agent Versions
        id: get-versions
        env:
          AZURE_AI_PROJECT_ENDPOINT: ${{ vars.AZURE_AI_PROJECT_ENDPOINT }}
          USE_LATEST: ${{ github.event.inputs.use_latest_version || 'true' }}
        run: |
          python << 'EOF'
          import os
          from azure.identity import DefaultAzureCredential
          from azure.ai.projects import AIProjectClient
          
          endpoint = os.environ["AZURE_AI_PROJECT_ENDPOINT"]
          use_latest = os.environ.get("USE_LATEST", "true").lower() == "true"
          
          agent_names = {
              "summary": "RfpSummaryAgent",
              "risk": "RfpRiskAgent", 
              "compliance": "RfpComplianceAgent",
              "orchestrator": "RfpOrchestratorAgent"
          }
          
          agent_versions = {}
          
          if use_latest:
              credential = DefaultAzureCredential()
              client = AIProjectClient(endpoint=endpoint, credential=credential)
              
              for key, name in agent_names.items():
                  try:
                      versions = list(client.agents.list_versions(agent_name=name))
                      latest = max(versions, key=lambda v: int(v.version))
                      agent_versions[key] = f"{name}:{latest.version}"
                      print(f"{name}: {len(versions)} version(s), using latest v{latest.version}")
                  except Exception as e:
                      agent_versions[key] = f"{name}:1"
                      print(f"{name}: failed ({e}), defaulting to v1")
          else:
              agent_versions = {k: f"{v}:1" for k, v in agent_names.items()}
          
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              for key in ["summary", "risk", "compliance", "orchestrator"]:
                  f.write(f"{key}_agent_id={agent_versions[key]}\n")
                  print(f"  {key}: {agent_versions[key]}")
          EOF

  # Evaluate Summary Agent
  evaluate-summary-agent:
    needs: fetch-agent-versions
    if: ${{ github.event.inputs.agent_type == 'all' || github.event.inputs.agent_type == 'summary' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    name: Evaluate RFP Summary Agent
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Run Summary Agent Evaluation
        uses: microsoft/ai-agent-evals@v3-beta
        with:
          azure-ai-project-endpoint: ${{ vars.AZURE_AI_PROJECT_ENDPOINT }}
          deployment-name: "gpt-4.1-mini"
          agent-ids: ${{ needs.fetch-agent-versions.outputs.summary_agent_id }}
          data-path: ${{ github.workspace }}/data/rfp-summary-evaluation.json

  # Evaluate Risk Agent
  evaluate-risk-agent:
    needs: fetch-agent-versions
    if: ${{ github.event.inputs.agent_type == 'all' || github.event.inputs.agent_type == 'risk' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    name: Evaluate RFP Risk Agent
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Run Risk Agent Evaluation
        uses: microsoft/ai-agent-evals@v3-beta
        with:
          azure-ai-project-endpoint: ${{ vars.AZURE_AI_PROJECT_ENDPOINT }}
          deployment-name: "gpt-4.1-mini"
          agent-ids: ${{ needs.fetch-agent-versions.outputs.risk_agent_id }}
          data-path: ${{ github.workspace }}/data/rfp-risk-evaluation.json

  # Evaluate Compliance Agent
  evaluate-compliance-agent:
    needs: fetch-agent-versions
    if: ${{ github.event.inputs.agent_type == 'all' || github.event.inputs.agent_type == 'compliance' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    name: Evaluate RFP Compliance Agent
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Run Compliance Agent Evaluation
        uses: microsoft/ai-agent-evals@v3-beta
        with:
          azure-ai-project-endpoint: ${{ vars.AZURE_AI_PROJECT_ENDPOINT }}
          deployment-name: "gpt-4.1-mini"
          agent-ids: ${{ needs.fetch-agent-versions.outputs.compliance_agent_id }}
          data-path: ${{ github.workspace }}/data/rfp-compliance-evaluation.json

  # Compare All Agents
  compare-all-agents:
    needs: [fetch-agent-versions, evaluate-summary-agent, evaluate-risk-agent, evaluate-compliance-agent]
    if: ${{ always() && (github.event.inputs.agent_type == 'all' || github.event_name == 'push') }}
    runs-on: ubuntu-latest
    name: Compare All RFP Agents
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Compare All Agents
        uses: microsoft/ai-agent-evals@v3-beta
        with:
          azure-ai-project-endpoint: ${{ vars.AZURE_AI_PROJECT_ENDPOINT }}
          deployment-name: "gpt-4.1-mini"
          agent-ids: "${{ needs.fetch-agent-versions.outputs.summary_agent_id }},${{ needs.fetch-agent-versions.outputs.risk_agent_id }},${{ needs.fetch-agent-versions.outputs.compliance_agent_id }}"
          baseline-agent-id: ${{ needs.fetch-agent-versions.outputs.summary_agent_id }}
          data-path: ${{ github.workspace }}/data/rfp-evaluation-dataset.json
