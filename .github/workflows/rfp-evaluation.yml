name: "RFP Agent Evaluation"

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      agent_type:
        description: 'Which agent to evaluate'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - summary
          - risk
          - compliance
      use_latest_version:
        description: 'Fetch latest agent versions from Foundry'
        required: true
        default: true
        type: boolean
  push:
    branches:
      - main
    paths:
      - 'data/**'
      - '.github/workflows/rfp-evaluation.yml'

permissions:
  id-token: write
  contents: read

env:
  # Default agent names (version fetched dynamically if use_latest_version=true)
  SUMMARY_AGENT_NAME: "RfpSummaryAgent"
  RISK_AGENT_NAME: "RfpRiskAgent"
  COMPLIANCE_AGENT_NAME: "RfpComplianceAgent"
  ORCHESTRATOR_AGENT_NAME: "RfpOrchestratorAgent"

jobs:
  # First job: Fetch latest agent versions from Foundry
  fetch-agent-versions:
    runs-on: ubuntu-latest
    name: Fetch Latest Agent Versions
    outputs:
      summary_agent_id: ${{ steps.get-versions.outputs.summary_agent_id }}
      risk_agent_id: ${{ steps.get-versions.outputs.risk_agent_id }}
      compliance_agent_id: ${{ steps.get-versions.outputs.compliance_agent_id }}
      orchestrator_agent_id: ${{ steps.get-versions.outputs.orchestrator_agent_id }}
    
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Azure SDK (preview - matches action's bundled SDK)
        run: pip install "azure-ai-projects>=1.0.0b1" --pre azure-identity

      - name: Get Latest Agent Versions
        id: get-versions
        env:
          AZURE_AI_PROJECT_ENDPOINT: ${{ vars.AZURE_AI_PROJECT_ENDPOINT }}
          USE_LATEST: ${{ github.event.inputs.use_latest_version || 'true' }}
        run: |
          python << 'EOF'
          import os, sys
          from azure.identity import DefaultAzureCredential
          from azure.ai.projects import AIProjectClient
          
          endpoint = os.environ["AZURE_AI_PROJECT_ENDPOINT"]
          use_latest = os.environ.get("USE_LATEST", "true").lower() == "true"
          
          # Print SDK versions for debugging
          import azure.ai.projects
          print(f"azure-ai-projects version: {azure.ai.projects.__version__}")
          try:
              import azure.ai.agents
              print(f"azure-ai-agents version: {azure.ai.agents.__version__}")
          except ImportError:
              print("azure-ai-agents: not installed (bundled in projects SDK)")
          print(f"Endpoint: {endpoint}")
          
          # Agent names to look up
          agent_names = {
              "summary": "RfpSummaryAgent",
              "risk": "RfpRiskAgent", 
              "compliance": "RfpComplianceAgent",
              "orchestrator": "RfpOrchestratorAgent"
          }
          
          if use_latest:
              try:
                  credential = DefaultAzureCredential()
                  client = AIProjectClient(endpoint=endpoint, credential=credential)
                  
                  # Debug: check what methods are available on client.agents
                  agent_ops = [m for m in dir(client.agents) if not m.startswith('_')]
                  print(f"\nAvailable agent operations: {agent_ops}")
                  
                  # Strategy 1: Try get_version (used by v3-beta action)
                  print("\n--- Strategy 1: get_version() ---")
                  agent_versions = {}
                  for name_key, agent_name in agent_names.items():
                      print(f"\nLooking up: {agent_name}")
                      found = False
                      for v in range(1, 15):
                          try:
                              agent = client.agents.get_version(agent_name=agent_name, agent_version=str(v))
                              agent_versions[name_key] = f"{agent_name}:{v}"
                              print(f"  v{v}: OK (id={agent.id}, name={agent.name})")
                              found = True
                          except Exception as e:
                              print(f"  v{v}: FAILED - {type(e).__name__}: {e}")
                              break
                      if not found:
                          agent_versions[name_key] = f"{agent_name}:1"
                          print(f"  => Defaulting to {agent_name}:1")
                  
                  # Strategy 2: If all failed, try list_agents for more debug info
                  if all(v.endswith(":1") for v in agent_versions.values()):
                      print("\n--- Strategy 2: list_agents() debug ---")
                      try:
                          agents_iter = client.agents.list_agents()
                          count = 0
                          for a in agents_iter:
                              count += 1
                              print(f"  Agent: name={a.name}, id={a.id}, version={getattr(a, 'version', 'N/A')}")
                              if count >= 30:
                                  break
                          print(f"  Total listed: {count}")
                      except Exception as e2:
                          print(f"  list_agents failed: {type(e2).__name__}: {e2}")
                          
              except Exception as e:
                  print(f"Error: {type(e).__name__}: {e}")
                  import traceback
                  traceback.print_exc()
                  agent_versions = {k: f"{v}:1" for k, v in agent_names.items()}
          else:
              agent_versions = {k: f"{v}:1" for k, v in agent_names.items()}
          
          # Pick the highest version found for each agent
          final_versions = {}
          for name_key, agent_id in agent_versions.items():
              name, ver = agent_id.rsplit(":", 1)
              final_versions[name_key] = agent_id
          
          # Write outputs
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"summary_agent_id={final_versions['summary']}\n")
              f.write(f"risk_agent_id={final_versions['risk']}\n")
              f.write(f"compliance_agent_id={final_versions['compliance']}\n")
              f.write(f"orchestrator_agent_id={final_versions['orchestrator']}\n")
          
          print("\n=== Final Agent Versions ===")
          for k, v in final_versions.items():
              print(f"  {k}: {v}")
          EOF

  # Evaluate Summary Agent
  evaluate-summary-agent:
    needs: fetch-agent-versions
    if: ${{ github.event.inputs.agent_type == 'all' || github.event.inputs.agent_type == 'summary' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    name: Evaluate RFP Summary Agent
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Run Summary Agent Evaluation
        uses: microsoft/ai-agent-evals@v3-beta
        with:
          azure-ai-project-endpoint: ${{ vars.AZURE_AI_PROJECT_ENDPOINT }}
          deployment-name: "gpt-4.1-mini"
          agent-ids: ${{ needs.fetch-agent-versions.outputs.summary_agent_id }}
          data-path: ${{ github.workspace }}/data/rfp-summary-evaluation.json

  # Evaluate Risk Agent
  evaluate-risk-agent:
    needs: fetch-agent-versions
    if: ${{ github.event.inputs.agent_type == 'all' || github.event.inputs.agent_type == 'risk' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    name: Evaluate RFP Risk Agent
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Run Risk Agent Evaluation
        uses: microsoft/ai-agent-evals@v3-beta
        with:
          azure-ai-project-endpoint: ${{ vars.AZURE_AI_PROJECT_ENDPOINT }}
          deployment-name: "gpt-4.1-mini"
          agent-ids: ${{ needs.fetch-agent-versions.outputs.risk_agent_id }}
          data-path: ${{ github.workspace }}/data/rfp-risk-evaluation.json

  # Evaluate Compliance Agent
  evaluate-compliance-agent:
    needs: fetch-agent-versions
    if: ${{ github.event.inputs.agent_type == 'all' || github.event.inputs.agent_type == 'compliance' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    name: Evaluate RFP Compliance Agent
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Run Compliance Agent Evaluation
        uses: microsoft/ai-agent-evals@v3-beta
        with:
          azure-ai-project-endpoint: ${{ vars.AZURE_AI_PROJECT_ENDPOINT }}
          deployment-name: "gpt-4.1-mini"
          agent-ids: ${{ needs.fetch-agent-versions.outputs.compliance_agent_id }}
          data-path: ${{ github.workspace }}/data/rfp-compliance-evaluation.json

  # Compare All Agents
  compare-all-agents:
    needs: [fetch-agent-versions, evaluate-summary-agent, evaluate-risk-agent, evaluate-compliance-agent]
    if: ${{ always() && (github.event.inputs.agent_type == 'all' || github.event_name == 'push') }}
    runs-on: ubuntu-latest
    name: Compare All RFP Agents
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Compare All Agents
        uses: microsoft/ai-agent-evals@v3-beta
        with:
          azure-ai-project-endpoint: ${{ vars.AZURE_AI_PROJECT_ENDPOINT }}
          deployment-name: "gpt-4.1-mini"
          agent-ids: "${{ needs.fetch-agent-versions.outputs.summary_agent_id }},${{ needs.fetch-agent-versions.outputs.risk_agent_id }},${{ needs.fetch-agent-versions.outputs.compliance_agent_id }}"
          baseline-agent-id: ${{ needs.fetch-agent-versions.outputs.summary_agent_id }}
          data-path: ${{ github.workspace }}/data/rfp-evaluation-dataset.json
